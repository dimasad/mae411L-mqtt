<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAE 411L MQTT Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- MQTT.js library - try local first, then CDN -->
    <script src="lib/mqtt.min.js"></script>
    <script>
        // Fallback to CDN if local library fails to load
        if (typeof mqtt === 'undefined') {
            console.warn('Local MQTT library not found. Trying CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mqtt@5.3.4/dist/mqtt.min.js';
            script.onerror = function() {
                console.error('Failed to load MQTT library from CDN. Creating minimal fallback.');
                window.mqtt = {
                    connect: function() {
                        console.warn('MQTT fallback: connect() called but library not available');
                        return {
                            on: function(event, callback) {
                                if (event === 'error') {
                                    setTimeout(() => callback(new Error('MQTT library not available')), 100);
                                }
                            },
                            subscribe: function() {},
                            unsubscribe: function() {},
                            publish: function() {},
                            end: function() {}
                        };
                    }
                };
            };
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <h1>MAE 411L Temperature Dashboard</h1>
            <div class="connection-bar">
                <button id="hamburger-menu" class="hamburger-btn" title="Settings">‚ò∞</button>
                <button id="connect-btn" class="connect-btn">Connect</button>
                <div class="status-indicator">
                    <span class="status-dot" id="status-dot"></span>
                    <span class="status-text" id="status-text">Disconnected</span>
                </div>
                <span class="broker-url" id="broker-url">wss://broker.emqx.io:8084/mqtt</span>
            </div>
        </header>

        <!-- Configuration Panel (Hidden by default) -->
        <div id="config-panel" class="config-panel hidden">
            <div class="config-content">
                <h3>MQTT Configuration</h3>
                <div class="config-row">
                    <label for="mqtt-host">Host:</label>
                    <input type="text" id="mqtt-host" value="broker.emqx.io" placeholder="broker.emqx.io">
                </div>
                <div class="config-row">
                    <label for="mqtt-port">Port:</label>
                    <input type="number" id="mqtt-port" value="8084" placeholder="8084">
                </div>
                <div class="config-row">
                    <label for="mqtt-path">WebSocket Path:</label>
                    <input type="text" id="mqtt-path" value="/mqtt" placeholder="/mqtt">
                </div>
                <div class="config-row">
                    <label for="mqtt-secure">Secure Connection (WSS):</label>
                    <input type="checkbox" id="mqtt-secure" checked>
                </div>
                <div class="config-row">
                    <label for="mqtt-username">Username:</label>
                    <input type="text" id="mqtt-username" placeholder="Optional">
                </div>
                <div class="config-row">
                    <label for="mqtt-password">Password:</label>
                    <input type="password" id="mqtt-password" placeholder="Optional">
                </div>
                <div class="config-row">
                    <label for="topic-prefix">Topic Prefix:</label>
                    <input type="text" id="topic-prefix" value="wvu-mae411L" placeholder="wvu-mae411L">
                </div>
                <div class="config-actions">
                    <button id="save-config" class="btn btn-primary">Save</button>
                    <button id="cancel-config" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <main class="dashboard">
            <!-- Controls -->
            <div class="controls">
                <button id="add-gauge-btn" class="btn btn-primary">+ Add Gauge</button>
            </div>

            <!-- Gauges Grid -->
            <div id="gauges-grid" class="gauges-grid">
                <!-- Initial gauge will be added here by JavaScript -->
            </div>
        </main>

        <!-- Add Gauge Modal -->
        <div id="add-gauge-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Add Temperature Gauge</h3>
                <div class="form-row">
                    <label for="gauge-group">Group Number:</label>
                    <input type="number" id="gauge-group" placeholder="1" min="1" max="99">
                </div>
                <div class="form-row">
                    <label for="gauge-topic">Custom Topic (optional):</label>
                    <input type="text" id="gauge-topic" placeholder="wvu-mae411L/group_1">
                </div>
                <div class="form-actions">
                    <button id="create-gauge" class="btn btn-primary">Create</button>
                    <button id="cancel-gauge" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Pane -->
    <div id="debug-pane" class="debug-pane minimized">
        <div id="debug-header" class="debug-header">
            <div class="debug-title">
                <span class="debug-icon">üêõ</span>
                Debug Console
            </div>
            <div id="debug-latest-event" class="debug-latest-event">No events logged</div>
            <div class="debug-controls">
                <button id="debug-clear" class="debug-btn" title="Clear log">üóëÔ∏è</button>
                <button id="debug-toggle" class="debug-toggle" title="Expand debug pane">‚ñ≤</button>
            </div>
        </div>
        <div id="debug-content" class="debug-content">
            <div class="debug-section">
                <h4>Event Log</h4>
                <div id="debug-events" class="debug-events"></div>
            </div>
            <div class="debug-section">
                <h4>Publish Message</h4>
                <div class="debug-publish">
                    <div class="publish-row">
                        <label for="publish-topic">Topic:</label>
                        <input type="text" id="publish-topic" placeholder="e.g., wvu-mae411L/test" class="publish-input">
                    </div>
                    <div class="publish-row">
                        <label for="publish-message">Message:</label>
                        <textarea id="publish-message" placeholder="Enter message to publish..." class="publish-textarea"></textarea>
                    </div>
                    <div class="publish-row">
                        <button id="publish-btn" class="publish-btn">Publish Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/debug-pane.js"></script>
    <script src="js/gauge.js"></script>
    <script src="js/mqtt-client.js"></script>
    <script src="js/dashboard.js"></script>
</body>
</html>